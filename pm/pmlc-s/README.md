# PMLC-S
胖喵小云集群管理软件

+ 主要功能:

  对 云计算服务器集群 (IaaS) 的 计算资源 (虚拟机, CPU, 内存),
  存储资源 (块设备, object 存储), 网络资源 (SDN) 等进行管理.

  基本替代 openstack.

+ 适用于: 2 ~ 16 台物理服务器

+ 主要目标:

  - 保持物理机干净

  - 降低系统复杂度

  - 减小攻击面


## 胖喵小云的特点

+ 微型: 服务器数量少, 通常每个集群不超过 20 台物理机.

+ 异地: 需要支持异地灾备, 比如每个集群 3 台物理机,
  一共 3 个集群分别在 3 个不同的城市.

+ 用户少: 通常不超过 10 个用户.

+ 低成本: 通常使用廉价二手硬件, 硬件性能较低.

+ 网速慢:

  集群之间 (异地) 可能只使用非对称百兆光纤宽带连接 (下载 100Mbps, 上传 10Mbps).

  集群内部的服务器之间可能只使用千兆/万兆以太网连接 (1Gbps, 10Gbps).

+ 混合云: 应用可能在 胖喵小云 和 公共云平台 上混合部署.


## 主要软件设计

+ 编程语言: rust

+ 主要功能实现基于 libvirt,
  底层使用 KVM/qemu 虚拟机.

+ 支持操作系统: Debian 11

+ 依赖:

  - libvirt, KVM/qemu

  - openssh

  - systemd

  - git

+ 主要组件:

  - `pmlc-c` 集群管理 (节点代理/外部接口)

  - `pmlc-s` 系统级管理操作 (root)

    自动化安装和环境配置 (物理机)

  - `pmlc-m` 监视: 日志收集和生成

  - `pmlc-v` 虚拟机 (计算资源) 管理

  - `pmlc-d` 存储资源管理

  - `pmlc-n` 网络资源管理 (SDN)

+ 测试: 软件测试需要 嵌套虚拟化 (硬件) 支持


## 安全

+ 多用户安全 (权限模型): PMRP-1

+ 使用 SELinux 严格限制各个组件的行为

+ rust: 禁止使用 unsafe

+ 高可用 (HA): 任意单个服务器故障, 不会导致集群整体故障

+ 异地灾备


## 存储资源管理

pmlc-d:

+ 块设备 (本地) 支持类型 (libvirt):

  - LVM 存储池

  - 数据文件 (比如 qcow2, vdi, vmdk)

+ object 存储: openstack swift

  跨多个集群异地部署, 运行在虚拟机中.

### 存储空间资源利用率

+ 高安全: 3 备份

+ 中安全: 2 备份

+ 低安全: 无备份

+ 超高安全: 异地 3 备份 + 光盘/磁带备份 + 公共云备份

### 物理机典型存储配置

底层存储设备:

+ 系统盘: SSD 磁盘阵列 RAID-1 (镜像)

+ 高安全硬盘: 磁盘阵列 RAID-5 (消耗一块盘的空间)

+ 低安全硬盘: 无阵列 LVM (大容量)

存储设备管理:

+ 安全存储区: RAID-5 之上使用 LVM

  - LVM 划分 LV 格式化 btrfs

    存储虚拟机磁盘文件 (比如 qcow2, vdi, vmdk)

  - 直接将 LV 分配给虚拟机

    用于重要的需要可靠性的虚拟机 (比如 k8s 集群)

+ 廉价存储区: 无阵列 LVM

  - LVM 划分 LV 格式化 btrfs

    存储虚拟机磁盘文件 (比如 qcow2, vdi, vmdk)

    用于不重要的可丢失损坏的虚拟机 (比如 测试虚拟机)

  - 直接将 LV 分配给虚拟机

    用于 openstack swift 数据存储盘


## 节点选举

pmlc-c:

+ 主节点: 1 个

+ 次节点: 1 个

+ 备用节点: 其余

TODO 节点选举算法
